
@page "/quiz"
@rendermode InteractiveServer
@using System.Linq
@using GlosApp.Models
@inject ApplicationDbContext DbContext

<div class="container">
    <h3>Quize</h3>
    <p>Testa dina kunskaper genom att svara på frågorna nedan, Läs texten först och svara sedan A, B eller C på det du tror är rätt.</p>
    <br/>
    <h2>Den magiska skogen</h2>
    <p>
        I utkanten av byn fanns en skog som ingen vågade gå in i. Träden var höga och täta, och det kändes alltid som om någon eller något iakttog en. Men en dag bestämde sig Ella och hennes bästa vän Leo för att utforska skogen. De hade hört rykten om en gömd skatt och ville ta reda på om det var sant.
    </p>
    <p>
        När de gick djupare in i skogen började det bli mörkare, trots att det var mitt på dagen. Löven prasslade, och de hörde ett svagt muller som verkade komma från marken. Plötsligt såg de något som glittrade mellan träden. Leo gick närmare och ropade: "Jag tror att vi har hittat något!" Det var en gammal karta, inristad på en sten. Kartan visade vägen till en stor ek som enligt legenden vaktade skatten.
    </p>
    <p>
        Ella och Leo följde kartan, och efter en stund stod de framför den stora eken. Trädet var enormt och såg väldigt gammalt ut. Men det var inte bara ett vanligt träd – runt stammen snurrade en svag, gyllene dimma, och marken under det verkade skimra. "Är det här?" frågade Ella, och Leo nickade. De började gräva vid trädets rötter, och efter en stunds arbete stötte de på något hårt. Det var en kista, täckt av lera och mossa. De öppnade den försiktigt och inuti fanns något de aldrig hade väntat sig – inte guld eller juveler, utan ett litet träd som verkade vara levande, trots att det var instängt i kistan.
    </p>
    <p>
        "Ett magiskt träd!" utbrast Leo. "Vi måste ta hand om det!" Ella höll med, och de bestämde sig för att återvända till byn och plantera trädet. Men när de lämnade skogen kändes det som om något, eller någon, fortfarande följde dem.
    </p>


    <EditForm Model="userAnswerForm" OnValidSubmit="CheckAnswers" novalidate autocomplete="off">
        @foreach (var answer in userAnswerForm.Answers)
        {
            <div class="form-group">
                <label>@answer.Swedish</label>
                <InputText @bind-Value="answer.UserAnswer" class="form-control" autocomplete="off" />
                @if (showResult)
                {
                    if (string.IsNullOrWhiteSpace(answer.UserAnswer))
                    {
                        <span class="text-warning">⚠️ Detta fält är tomt.</span>
                    }
                    else if (answer.UserAnswer.Equals(answer.English, StringComparison.OrdinalIgnoreCase))
                    {
                        <span class="text-success">✔️ Rätt!</span>
                    }
                    else
                    {
                        <span class="text-danger">❌ Fel, rätt svar är "@answer.English".</span>
                    }
                }
            </div>
        }

        @if (showResult)
        {
            <div class="alert alert-info">
                Du fick @correctAnswers av @userAnswerForm.Answers.Count ord rätt!
            </div>
        }

        @if (missingAnswers)
        {
            <div class="alert alert-warning">
                Du måste fylla i alla fält innan du kan kontrollera dina svar.
            </div>
        }

        <button type="submit" class="btn btn-primary">Kontrollera svar</button>
        <button type="button" class="btn btn-success" @onclick="ResetForm">Rensa glosformuläret</button>
    </EditForm>

</div>

@code {
    private UserAnswerForm userAnswerForm = new UserAnswerForm();
    private int correctAnswers = 0;
    private bool showResult = false;
    private bool missingAnswers = false;

    protected override void OnInitialized()
    {
        userAnswerForm.Answers = new List<WordAnswer>
    {
            new WordAnswer("Vad hittade Ella och Leo i skogen? - A) En sko - B) Ett magiskt träd - C) En gammal tall", "B"),
            new WordAnswer("Vad var speciellt med trädet de hittade? - A) Det var täckt av gyllene löv - B) Det vakade över en skatt - C) Det var instängt i en kista", "C"),
            new WordAnswer("Hur kände sig Ella och Leo när de lämnade skogen? - A) De var glada och lättade - B) De kände sig bevakade - C) De var rädda för mörkret", "B"),
            new WordAnswer("Vad bestämde sig Ella och Leo för att göra med det magiska trädet? - A) De lämnade det i skogen - B) De tog det hem för att plantera det - B) De gav det till byns äldste", "B"),
            new WordAnswer("Ella och Leo gick in i skogen för att hitta: - A) En skatt - B) Ett hus - C) En ek", "A"),
            new WordAnswer("Skatten de hittade var: - A) En gyllene kista - B) Ett litet magiskt träd - C) En sten med inristningar", "B")

    };
    }


    private void CheckAnswers()
    {
        missingAnswers = userAnswerForm.Answers.Any(answer => string.IsNullOrWhiteSpace(answer.UserAnswer));

        if (missingAnswers)
        {
            showResult = false;
            return;
        }

        correctAnswers = userAnswerForm.Answers.Count(answer =>
            answer.UserAnswer?.Trim().Equals(answer.English.Trim(), StringComparison.OrdinalIgnoreCase) == true);

        foreach (var answer in userAnswerForm.Answers)
        {
            DbContext.WordAnswers.Add(new WordAnswer
                {
                    Swedish = answer.Swedish,
                    English = answer.English,
                    UserAnswer = answer.UserAnswer,
                    Language = "English"
                });
        }

        DbContext.SaveChanges();
        showResult = true;
    }


    private void ResetForm()
    {
        foreach (var answer in userAnswerForm.Answers)
        {
            answer.UserAnswer = string.Empty;
        }

        correctAnswers = 0;
        showResult = false;
        missingAnswers = false;
    }

    public class UserAnswerForm
    {
        public List<WordAnswer> Answers { get; set; } = new List<WordAnswer>();
    }
}
